{% extends "base.html" %}

{% block title %}H·ªá th·ªëng nh·∫≠n di·ªán bi·ªÉn s·ªë & t√≠nh to√°n t·ªëc ƒë·ªô{% endblock %}

{% block extra_css %}
<!-- Font Awesome ƒë√£ ƒë∆∞·ª£c load trong base.html, kh√¥ng c·∫ßn load l·∫°i -->
<!-- Google font Poppins - ƒê·ªìng nh·∫•t v·ªõi h·ªá th·ªëng -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
    /* ƒê·ªìng nh·∫•t font cho to√†n b·ªô trang */
    * {
        font-family: "Poppins", sans-serif !important;
    }
    .hero-header {
        background: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
        color: white;
        border-radius: 18px;
        padding: 35px 40px;
        margin-bottom: 30px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.25);
        position: relative;
        overflow: hidden;
        border: 1px solid rgba(255,255,255,0.1);
    }

    .hero-header::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(0,212,255,0.1) 0%, transparent 50%);
        animation: rotate 20s linear infinite;
    }

    @keyframes rotate {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }

    .hero-header * {
        position: relative;
        z-index: 1;
    }

    .main-title {
        font-size: 32px;
        font-weight: 800;
        margin-bottom: 12px;
        text-shadow: 2px 2px 8px rgba(0,0,0,0.3);
        letter-spacing: -0.5px;
        background: linear-gradient(90deg, #fff, #00d4ff);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .subtitle {
        font-size: 16px;
        opacity: 0.9;
        font-weight: 400;
        letter-spacing: 0.3px;
    }

    /* 6-Thread Architecture Badge */
    .architecture-badge {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background: linear-gradient(135deg, #00d4ff 0%, #0066ff 100%);
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        margin-top: 12px;
        box-shadow: 0 4px 15px rgba(0,212,255,0.4);
    }

    .architecture-badge i {
        font-size: 14px;
    }
    .dash-card {
        background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%);
        border-radius: 16px;
        padding: 28px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        margin-bottom: 20px;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        border: 1px solid rgba(0,0,0,0.05);
        position: relative;
        overflow: hidden;
    }

    .dash-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 4px;
        height: 100%;
        background: linear-gradient(180deg, #00d4ff 0%, #0066ff 100%);
        transition: width 0.4s ease;
    }

    .dash-card:hover {
        transform: translateY(-8px) scale(1.02);
        box-shadow: 0 20px 40px rgba(0,102,255,0.15);
        border-color: rgba(0,212,255,0.3);
    }

    .dash-card:hover::before {
        width: 100%;
        opacity: 0.08;
    }

    .dash-icon {
        width: 70px;
        height: 70px;
        border-radius: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 18px;
        font-size: 28px;
        color: white;
        box-shadow: 0 8px 20px rgba(0,0,0,0.2);
    }

    .bg-red {
        background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
    }
    .bg-blue {
        background: linear-gradient(135deg, #00d4ff 0%, #0066ff 100%);
    }
    .bg-green {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    }

    .dash-info h6 {
        color: #6c757d;
        font-size: 14px;
        margin-bottom: 10px;
    }
    .dash-info h2 {
        font-size: 32px;
        font-weight: 700;
        color: #333;
    }

    /* ================= MONITORING SYSTEM STYLES ================= */
    .monitoring-card {
        background: linear-gradient(145deg, #1a1a2e 0%, #0f0f1a 100%);
        border: 1px solid rgba(0,212,255,0.2);
        box-shadow: 0 10px 40px rgba(0,0,0,0.4);
        border-radius: 20px;
    }

    .monitoring-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 18px 25px;
        background: linear-gradient(135deg, rgba(0,212,255,0.1) 0%, rgba(0,102,255,0.1) 100%);
        border-radius: 16px;
        margin-bottom: 20px;
        border: 1px solid rgba(0,212,255,0.15);
    }

    .monitoring-title {
        color: #fff;
        font-size: 22px;
        font-weight: 700;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .monitoring-title i {
        color: #00d4ff;
        font-size: 26px;
        filter: drop-shadow(0 0 8px rgba(0,212,255,0.5));
    }

    .status-indicator {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .status-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #666;
        animation: pulse 2s infinite;
    }

    .status-dot.active {
        background: #00ff00;
        box-shadow: 0 0 10px #00ff00;
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    .status-text {
        color: #fff;
        font-weight: 600;
        font-size: 14px;
    }

    .video-grid-wrapper {
        background: #000;
        border-radius: 12px;
        padding: 20px;
        position: relative;
        box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
        min-height: 450px; /* TƒÉng chi·ªÅu cao t·ªëi thi·ªÉu */
    }

    /* Khi c√≥ video upload, hi·ªÉn th·ªã full */
    .video-grid-wrapper.has-upload {
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
    }

    .video-grid {
        display: grid;
        grid-template-columns: 1fr; /* 1 c·ªôt khi c√≥ video upload */
        gap: 15px;
        width: 100%;
        min-height: 400px; /* TƒÉng chi·ªÅu cao grid */
    }

    /* Khi c√≥ nhi·ªÅu video, hi·ªÉn th·ªã 3 c·ªôt */
    .video-grid.multi-video {
        grid-template-columns: repeat(3, 1fr);
    }
    
    /* Responsive: Tr√™n m√†n h√¨nh nh·ªè h∆°n, hi·ªÉn th·ªã 2 c·ªôt */
    @media (max-width: 1200px) {
        .video-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }
    
    /* Responsive: Tr√™n m√†n h√¨nh r·∫•t nh·ªè, hi·ªÉn th·ªã 1 c·ªôt */
    @media (max-width: 768px) {
        .video-grid {
            grid-template-columns: 1fr;
        }
    }

    .video-item {
        position: relative;
        background: #000;
        border-radius: 8px;
        overflow: hidden;
        border: 2px solid #16213e;
        transition: all 0.3s ease;
    }

    .video-item:hover {
        border-color: #00d4ff;
        box-shadow: 0 0 20px rgba(0,212,255,0.5);
        transform: translateY(-2px);
    }

    .video-item.active {
        border-color: #00ff00;
        box-shadow: 0 0 25px rgba(0,255,0,0.6);
    }

    .video-item-wrapper {
        position: relative;
        width: 100%;
        padding-top: 56.25%; /* 16:9 aspect ratio */
    }

    .monitoring-video {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 6px;
    }

    .video-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(to bottom, rgba(0,0,0,0.8) 0%, transparent 40%);
        pointer-events: none;
        border-radius: 6px;
    }

    .video-label {
        position: absolute;
        top: 10px;
        left: 10px;
        background: rgba(0,0,0,0.8);
        padding: 6px 12px;
        border-radius: 6px;
        border-left: 3px solid #00d4ff;
        color: #fff;
        font-size: 12px;
        font-weight: 700;
        z-index: 10;
    }
    
    .video-location {
        position: absolute;
        bottom: 10px;
        left: 10px;
        right: 10px;
        background: rgba(0,0,0,0.85);
        padding: 8px 12px;
        border-radius: 6px;
        border-left: 3px solid #00ff00;
        color: #fff;
        font-size: 11px;
        font-weight: 600;
        z-index: 10;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .video-location:hover {
        background: rgba(0,0,0,0.95);
        border-left-color: #00d4ff;
    }
    
    .video-location-input {
        width: 100%;
        background: rgba(255,255,255,0.95);
        color: #000;
        border: 2px solid #00d4ff;
        border-radius: 4px;
        padding: 6px 10px;
        font-size: 11px;
        font-weight: 600;
        font-family: "Poppins", sans-serif;
    }
    
    .video-location-input:focus {
        outline: none;
        border-color: #00ff00;
        box-shadow: 0 0 8px rgba(0,255,0,0.5);
    }
    
    .edit-location-btn {
        position: absolute;
        bottom: 10px;
        right: 10px;
        background: rgba(0,212,255,0.9);
        color: #fff;
        border: none;
        border-radius: 50%;
        width: 28px;
        height: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        z-index: 11;
        font-size: 12px;
        transition: all 0.3s ease;
    }
    
    .edit-location-btn:hover {
        background: rgba(0,255,0,0.9);
        transform: scale(1.1);
    }

    .system-info-bar {
        display: flex;
        gap: 20px;
        padding: 15px 20px;
        background: #16213e;
        border-radius: 12px;
        margin-top: 15px;
        flex-wrap: wrap;
    }

    .system-info-bar .info-item {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .system-info-bar .info-label {
        color: #aaa;
        font-size: 13px;
        font-weight: 600;
    }

    .system-info-bar .info-value {
        color: #fff;
        font-size: 14px;
        font-weight: 700;
    }

    .status-active {
        color: #00ff00 !important;
    }

    .video-controls {
        margin-top: 20px;
        padding: 20px;
        background: #16213e;
        border-radius: 12px;
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    .control-group {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }

    .control-group .btn {
        flex: 1;
        min-width: 150px;
        padding: 12px;
        font-weight: 600;
        border-radius: 8px;
        transition: all 0.3s ease;
    }

    .control-group .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }

    .upload-section {
        margin-top: 15px;
        padding: 15px;
        background: rgba(0,0,0,0.3);
        border-radius: 8px;
        border: 1px solid #00d4ff;
    }

    .upload-form {
        display: flex;
        gap: 10px;
        align-items: flex-end;
        flex-wrap: wrap;
    }

    .upload-form .form-group {
        flex: 1;
        min-width: 250px;
    }

    .upload-form .form-control {
        background: #0f3460;
        border: 1px solid #00d4ff;
        color: #fff;
        border-radius: 6px;
        padding: 8px 12px;
    }

    .upload-form .form-control:focus {
        background: #1a4a7a;
        border-color: #00d4ff;
        color: #fff;
        box-shadow: 0 0 10px rgba(0,212,255,0.3);
    }

    .upload-form .btn-sm {
        padding: 8px 16px;
        font-size: 13px;
    }

    /* Styles for uploaded video with detection - PH√ìNG TO */
    .uploaded-video {
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
        border: 3px solid #00ff00 !important;
        box-shadow: 0 0 30px rgba(0,255,0,0.5) !important;
        grid-column: 1 / -1; /* Chi·∫øm to√†n b·ªô chi·ªÅu r·ªông */
        max-width: 100%; /* Full width */
        margin: 0 auto; /* CƒÉn gi·ªØa */
        background: #000;
        min-height: 400px; /* ƒê·∫£m b·∫£o c√≥ chi·ªÅu cao t·ªëi thi·ªÉu */
    }

    .uploaded-video:hover {
        border-color: #00ff00 !important;
        box-shadow: 0 0 40px rgba(0,255,0,0.7) !important;
    }

    /* TƒÉng k√≠ch th∆∞·ªõc video wrapper cho uploaded video */
    .uploaded-video .video-item-wrapper {
        padding-top: 56.25%; /* 16:9 aspect ratio */
        min-height: 350px;
        position: relative;
    }

    /* ƒê·∫£m b·∫£o stream image hi·ªÉn th·ªã ƒë√∫ng */
    .uploaded-video .stream-video {
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: contain;
        background: #000;
    }

    .stream-video {
        border-radius: 6px;
    }

    .status-dot-small {
        display: inline-block;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #00ff00;
        margin-right: 6px;
        animation: pulse 2s infinite;
        vertical-align: middle;
    }
    
    /* T·ªêI ∆ØU: Video list styles - ch·ªâ load khi click */
    .video-list-wrapper {
        margin-top: 20px;
    }
    
    .video-list-header {
        margin-bottom: 15px;
    }
    
    .video-list-header h5 {
        color: #fff;
        font-weight: 600;
        margin-bottom: 5px;
    }
    
    .video-list-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 15px;
    }
    
    .video-list-item {
        background: #16213e;
        border: 2px solid #0f3460;
        border-radius: 8px;
        padding: 15px;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
    }
    
    .video-list-item:hover {
        border-color: #00d4ff;
        box-shadow: 0 0 15px rgba(0,212,255,0.4);
        transform: translateY(-2px);
    }
    
    .video-list-item.active {
        border-color: #00ff00;
        box-shadow: 0 0 20px rgba(0,255,0,0.5);
    }
    
    .video-list-item-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 10px;
    }
    
    .video-list-item-title {
        color: #fff;
        font-weight: 600;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .video-list-item-status {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: #666;
    }
    
    .video-list-item-status.playing {
        background: #00ff00;
        animation: pulse 2s infinite;
    }
    
    .video-list-item-location {
        color: #aaa;
        font-size: 12px;
        display: flex;
        align-items: center;
        gap: 5px;
    }
    
    .video-list-item-actions {
        margin-top: 10px;
        display: flex;
        gap: 8px;
    }
    
    .video-list-item-btn {
        flex: 1;
        padding: 6px 12px;
        background: #0f3460;
        border: 1px solid #00d4ff;
        color: #00d4ff;
        border-radius: 4px;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .video-list-item-btn:hover {
        background: #00d4ff;
        color: #000;
    }
    
    .video-list-item-btn.active {
        background: #00ff00;
        border-color: #00ff00;
        color: #000;
    }

    .video-status-badge {
        position: absolute;
        top: 10px;
        right: 10px;
        background: rgba(0,0,0,0.8);
        padding: 6px 12px;
        border-radius: 6px;
        color: #00ff00;
        font-size: 11px;
        font-weight: 600;
        z-index: 10;
    }
</style>
{% endblock %}

{% block page_title %}{% endblock %}

{% block content %}
<!-- ============ HERO ============ -->
<div class="hero-header text-center">
    <h1 class="main-title">
        <i class="fas fa-road" style="margin-right: 10px;"></i> H·ªÜ TH·ªêNG NH·∫¨N DI·ªÜN BI·ªÇN S·ªê & T√çNH TO√ÅN T·ªêC ƒê·ªò
    </h1>
    <p class="subtitle">
        <i class="fas fa-microchip" style="margin-right: 8px;"></i> ·ª®ng d·ª•ng Tr√≠ tu·ªá Nh√¢n t·∫°o trong gi√°m s√°t giao th√¥ng th·ªùi gian th·ª±c
    </p>
    <div class="architecture-badge">
        <i class="fas fa-bolt"></i> M√î H√åNH | YOLO + OC-SORT + FastALPR
    </div>
</div>

<!-- ================= DASHBOARD ================= -->
<div class="row justify-content-center dashboard-row text-center mb-4">
    <div class="col-md-3">
        <div class="dash-card">
            <div class="dash-icon bg-red">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <div class="dash-info">
                <h6><i class="fas fa-exclamation-triangle"></i> T·ªïng vi ph·∫°m h√¥m nay</h6>
                <h2 id="total">{{ total or 0 }}</h2>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="dash-card">
            <div class="dash-icon bg-blue">
                <i class="fas fa-car"></i>
            </div>
            <div class="dash-info">
                <h6><i class="fas fa-car"></i> S·ªë xe ƒë√£ qu√©t</h6>
                <h2 id="vehicles">{{ vehicles or 0 }}</h2>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="dash-card">
            <div class="dash-icon bg-green">
                <i class="fas fa-tachometer-alt"></i>
            </div>
            <div class="dash-info">
                <h6><i class="fas fa-tachometer-alt"></i> T·ªëc ƒë·ªô trung b√¨nh</h6>
                <h2 id="avg_speed">{{ avg_speed or 0 }} km/h</h2>
            </div>
        </div>
    </div>
</div>

<!-- ================= VIDEO MONITORING SYSTEM ================= -->
<div class="card mt-4 monitoring-card">
    <div class="card-body">
        <div class="monitoring-header">
            <h4 class="monitoring-title">
                <i class="fas fa-video"></i> H·ªÜ TH·ªêNG GI√ÅM S√ÅT GIAO TH√îNG
            </h4>
            <div class="status-indicator">
                <span class="status-dot active"></span>
                <span class="status-text">ƒêang ho·∫°t ƒë·ªông</span>
            </div>
        </div>

        <!-- T·ªêI ∆ØU: Danh s√°ch video demo - ch·ªâ load khi click -->
        <div class="video-list-wrapper" id="videoListWrapper" style="display: block;">
            <div class="video-list-header mb-3">
                <h5 class="text-white">
                    <i class="fas fa-list"></i> Danh s√°ch Camera Demo (6 camera)
                </h5>
                <p class="text-muted small">Nh·∫•n v√†o camera ƒë·ªÉ xem video. Ch·ªâ load video khi c·∫ßn ƒë·ªÉ t·ªëi ∆∞u hi·ªáu su·∫•t.</p>
            </div>
            <div class="video-list-container" id="videoListContainer">
                <!-- Video list items will be dynamically inserted here -->
            </div>
        </div>
        
        <!-- Video player area - ch·ªâ hi·ªÉn th·ªã khi ch·ªçn video ho·∫∑c upload -->
        <div class="video-grid-wrapper" id="videoGridWrapper" style="display: none;">
            <div class="video-grid" id="videoGrid">
                <!-- Selected video will be displayed here -->
            </div>
        </div>

        <!-- LIVE STREAM - Hi·ªÉn th·ªã khi upload video -->
        <div id="liveStreamContainer" style="display: none; background: #000; border-radius: 12px; padding: 10px; margin-bottom: 20px; max-width: 1280px; margin-left: auto; margin-right: auto;">
            <div class="video-overlay-container" style="position: relative; width: 100%; padding-top: 56.25%; background: #111; border-radius: 8px; overflow: hidden; border: 2px solid #00ff00;">
                <!-- Layer 1: Video Stream (Bottom) -->
                <!-- Layer 1: Video Stream (Bottom) -->
                <img id="liveStreamImg"
                     class="video-base-layer"
                     style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: contain; background: #000; 
                            image-rendering: auto; 
                            -webkit-backface-visibility: hidden;
                            backface-visibility: hidden;
                            transform: translateZ(0);
                            will-change: contents; z-index: 1;"
                     alt="Live Detection Stream">
                
                <!-- Layer 2: Canvas Overlay (Top) -->
                <canvas id="bboxCanvas"
                        class="bbox-overlay-layer"
                        style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 2;">
                </canvas>
                
                <!-- Overlay Controls -->
                <div class="overlay-controls" style="position: absolute; top: 10px; right: 10px; display: flex; gap: 8px; z-index: 3;">
                    <button id="toggleBbox" class="btn btn-sm btn-primary" style="background: rgba(0,0,0,0.7); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 4px 10px; border-radius: 4px; font-size: 11px; cursor: pointer;">
                        <i class="fas fa-eye"></i> <span id="bboxStatus">Bbox: ON</span>
                    </button>
                    <button id="toggleSpeed" class="btn btn-sm btn-primary" style="background: rgba(0,0,0,0.7); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 4px 10px; border-radius: 4px; font-size: 11px; cursor: pointer;">
                        <i class="fas fa-tachometer-alt"></i> <span id="speedStatus">Speed: ON</span>
                    </button>
                </div>
                
                <div style="position: absolute; top: 8px; left: 8px; background: rgba(0,255,0,0.9); color: #000; padding: 4px 10px; border-radius: 4px; font-weight: bold; font-size: 11px; z-index: 3;">
                    <i class="fas fa-circle" style="color: red; animation: blink 1s infinite;"></i> LIVE
                </div>
                <div style="position: absolute; bottom: 8px; right: 8px; background: rgba(0,0,0,0.8); color: #fff; padding: 4px 10px; border-radius: 4px; font-size: 10px;">
                    YOLO + OC-SORT + FastALPR
                </div>
            </div>
            <style>
                @keyframes blink {
                    0%, 100% { opacity: 1; }
                    50% { opacity: 0.3; }
                }
            </style>
        </div>
        
        <div class="system-info-bar">
            <div class="info-item">
                <span class="info-label">Th·ªùi gian h·ªá th·ªëng:</span>
                <span class="info-value" id="currentTime">--:--:--</span>
            </div>
            <div class="info-item">
                <span class="info-label">T·ªïng s·ªë camera:</span>
                <span class="info-value">6</span>
            </div>
            <div class="info-item">
                <span class="info-label">Tr·∫°ng th√°i:</span>
                <span class="info-value status-active">T·∫•t c·∫£ ƒëang ho·∫°t ƒë·ªông</span>
            </div>
        </div>

        <div class="video-controls">
            <div class="control-group">
                <button id="playAllBtn" class="btn btn-primary">
                    <i class="fas fa-play"></i> Ph√°t t·∫•t c·∫£
                </button>
                <button id="pauseAllBtn" class="btn btn-secondary">
                    <i class="fas fa-pause"></i> T·∫°m d·ª´ng t·∫•t c·∫£
                </button>
                <button id="uploadVideoBtn" class="btn btn-success">
                    <i class="fas fa-upload"></i> Upload Video
                </button>
                <button id="stopVideoUploadBtn" class="btn btn-danger" style="display: none;">
                    <i class="fas fa-stop-circle"></i> D·ª´ng Video Upload
                </button>
            </div>
            <div class="upload-section" id="uploadSection" style="display: none;">
                <form id="uploadForm" enctype="multipart/form-data" class="upload-form">
                    <div class="form-group">
                        <input type="file" id="videoInput" name="video" accept="video/*" required class="form-control">
                    </div>
                    <button type="submit" class="btn btn-success btn-sm">
                        <i class="fas fa-check"></i> X√°c nh·∫≠n upload
                    </button>
                    <button type="button" id="cancelUploadBtn" class="btn btn-secondary btn-sm">
                        <i class="fas fa-times"></i> H·ªßy
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<div id="alert-box"
     class="d-none"
     style="background: #ffdddd;
            border: 1px solid red;
            padding: 10px;
            margin-bottom: 10px;
            font-weight: bold;">
</div>

<!-- =========== HISTORY TABLE =========== -->
<div class="card mt-4 mb-5">
    <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h3 class="mb-0">
                <i class="fas fa-history"></i> L·ªãch s·ª≠ vi ph·∫°m
            </h3>
            <span class="badge badge-info" id="history-count">ƒêang t·∫£i...</span>
        </div>
        <div class="history-wrapper" style="overflow-x: auto;">
            <table class="table table-sm table-bordered table-hover mt-3" style="min-width: 100%;">
                <thead class="thead-light">
                <tr>
                    <th><i class="fas fa-car"></i> Bi·ªÉn s·ªë</th>
                    <th><i class="fas fa-truck"></i> Lo·∫°i xe</th>
                    <th><i class="fas fa-user"></i> T√™n ch·ªß xe</th>
                    <th><i class="fas fa-map-marker-alt"></i> ƒê·ªãa ch·ªâ</th>
                    <th><i class="fas fa-phone"></i> SƒêT</th>
                    <th><i class="fas fa-tachometer-alt"></i> T·ªëc ƒë·ªô</th>
                    <th><i class="fas fa-ban"></i> Gi·ªõi h·∫°n</th>
                    <th><i class="fas fa-exclamation-triangle"></i> V∆∞·ª£t qu√°</th>
                    <th><i class="fas fa-clock"></i> Th·ªùi gian</th>
                    <th><i class="fas fa-image"></i> ·∫¢nh bi·ªÉn s·ªë</th>
                    <th><i class="fas fa-camera"></i> ·∫¢nh vi ph·∫°m</th>
                </tr>
                </thead>
                <tbody id="history-table">
                    <tr>
                    <td colspan="10" class="text-center text-muted">
                        <i class="fas fa-spinner fa-spin"></i> ƒêang t·∫£i d·ªØ li·ªáu...
                    </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Load jQuery tr∆∞·ªõc, kh√¥ng defer ƒë·ªÉ ƒë·∫£m b·∫£o s·∫µn s√†ng khi d√πng -->
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
<!-- File main.js kh√¥ng t·ªìn t·∫°i, ƒë√£ x√≥a reference -->
<script>
    // T·ªêI ∆ØU: Video list system - ch·ªâ load khi click
    const videos = [
        { path: '/video_demo/1.mp4', name: 'Camera 1' },
        { path: '/video_demo/2.mp4', name: 'Camera 2' },
        { path: '/video_demo/3.mp4', name: 'Camera 3' },
        { path: '/video_demo/4.mp4', name: 'Camera 4' },
        { path: '/video_demo/5.mp4', name: 'Camera 5' },
        { path: '/video_demo/6.mp4', name: 'Camera 6' }
    ];
    
    let videoPlayers = [];
    let isAllPlaying = false;
    let currentPlayingVideo = null; // Video ƒëang ƒë∆∞·ª£c ph√°t
    
    // T·ªêI ∆ØU: Kh·ªüi t·∫°o danh s√°ch video (KH√îNG load video)
    function initVideoList() {
        const videoListContainer = document.getElementById('videoListContainer');
        if (!videoListContainer) return;
        
        videoListContainer.innerHTML = '';
        
        videos.forEach((video, index) => {
            // T·∫°o list item
            const listItem = document.createElement('div');
            listItem.className = 'video-list-item';
            listItem.id = `video-list-item-${index}`;
            listItem.dataset.videoIndex = index;
            listItem.dataset.videoPath = video.path;
            
            // Load saved location
            const savedLocation = localStorage.getItem(`camera_${index + 1}_location`) || '';
            
            listItem.innerHTML = `
                <div class="video-list-item-header">
                    <div class="video-list-item-title">
                        <i class="fas fa-video"></i> ${video.name}
                    </div>
                    <div class="video-list-item-status" id="status-${index}"></div>
                </div>
                <div class="video-list-item-location">
                    <i class="fas fa-map-marker-alt"></i> 
                    <span id="location-text-${index}">${savedLocation || 'Ch∆∞a ƒë·∫∑t t√™n ƒë∆∞·ªùng'}</span>
                </div>
                <div class="video-list-item-actions">
                    <button class="video-list-item-btn" onclick="loadAndPlayVideo(${index})">
                        <i class="fas fa-play"></i> Xem video
                    </button>
                    <button class="video-list-item-btn" onclick="editLocation(${index + 1}, document.getElementById('location-text-${index}'))">
                        <i class="fas fa-edit"></i> S·ª≠a ƒë·ªãa ƒëi·ªÉm
                    </button>
                </div>
            `;
            
            videoListContainer.appendChild(listItem);
        });
        
        console.log('[VIDEO LIST] ‚úÖ ƒê√£ kh·ªüi t·∫°o danh s√°ch video (kh√¥ng load video)');
    }
    
    // T·ªêI ∆ØU: Load v√† ph√°t video khi user click
    function loadAndPlayVideo(index) {
        const video = videos[index];
        if (!video) return;
        
        // D·ª´ng video c≈© n·∫øu c√≥
        if (currentPlayingVideo !== null && currentPlayingVideo !== index) {
            stopVideo(currentPlayingVideo);
        }
        
        // N·∫øu ƒëang ph√°t video n√†y, d·ª´ng l·∫°i
        if (currentPlayingVideo === index) {
            stopVideo(index);
            return;
        }
        
        // Hi·ªÉn th·ªã video grid
        const videoGridWrapper = document.getElementById('videoGridWrapper');
        const videoListWrapper = document.getElementById('videoListWrapper');
        if (videoGridWrapper) videoGridWrapper.style.display = 'block';
        if (videoListWrapper) videoListWrapper.style.display = 'none';
        
        // T·∫°o video player
        const videoGrid = document.getElementById('videoGrid');
        if (!videoGrid) return;
        
        videoGrid.innerHTML = '';
        videoPlayers = [];
        
        // T·∫°o video element
        const videoItem = document.createElement('div');
        videoItem.className = 'video-item active';
        videoItem.id = `video-item-${index}`;
        
        const videoWrapper = document.createElement('div');
        videoWrapper.className = 'video-item-wrapper';
        
        const videoElement = document.createElement('video');
        videoElement.className = 'monitoring-video';
        videoElement.src = video.path;
        videoElement.autoplay = true;
        videoElement.muted = true;
        videoElement.loop = true;
        videoElement.playsInline = true;
        videoElement.id = `video-${index}`;
        
        // Error handling
        videoElement.addEventListener('error', function(e) {
            console.error(`[VIDEO ERROR] ${video.name}:`, e);
            this.style.backgroundColor = '#000';
            this.style.display = 'flex';
            this.style.alignItems = 'center';
            this.style.justifyContent = 'center';
            this.innerHTML = `<span style="color: #fff; font-size: 12px;">L·ªói t·∫£i video</span>`;
        });
        
        // Create overlay v√† label
        const overlay = document.createElement('div');
        overlay.className = 'video-overlay';
        
        const label = document.createElement('div');
        label.className = 'video-label';
        label.textContent = video.name;
        
        const locationDiv = document.createElement('div');
        locationDiv.className = 'video-location';
        locationDiv.id = `location-${index}`;
        const savedLocation = localStorage.getItem(`camera_${index + 1}_location`) || '';
        if (savedLocation) {
            locationDiv.textContent = `üìç ${savedLocation}`;
            locationDiv.setAttribute('data-location', savedLocation);
        } else {
            locationDiv.textContent = 'üìç Nh·∫•n ƒë·ªÉ nh·∫≠p t√™n ƒë∆∞·ªùng';
            locationDiv.setAttribute('data-location', '');
        }
        locationDiv.addEventListener('click', function() {
            editLocation(index + 1, this);
        });
        
        const editBtn = document.createElement('button');
        editBtn.className = 'edit-location-btn';
        editBtn.innerHTML = '<i class="fas fa-edit"></i>';
        editBtn.title = 'S·ª≠a th√¥ng tin ƒë∆∞·ªùng';
        editBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            editLocation(index + 1, locationDiv);
        });
        
        // Assemble
        videoWrapper.appendChild(videoElement);
        videoWrapper.appendChild(overlay);
        videoWrapper.appendChild(label);
        videoWrapper.appendChild(locationDiv);
        videoWrapper.appendChild(editBtn);
        videoItem.appendChild(videoWrapper);
        videoGrid.appendChild(videoItem);
        
        videoPlayers.push(videoElement);
        currentPlayingVideo = index;
        
        // C·∫≠p nh·∫≠t status
        updateVideoStatus(index, true);
        
        // Th√™m n√∫t quay l·∫°i danh s√°ch
        const backBtn = document.createElement('button');
        backBtn.className = 'btn btn-secondary mt-3';
        backBtn.innerHTML = '<i class="fas fa-arrow-left"></i> Quay l·∫°i danh s√°ch';
        backBtn.onclick = function() {
            stopVideo(index);
            const videoGridWrapper = document.getElementById('videoGridWrapper');
            const videoListWrapper = document.getElementById('videoListWrapper');
            if (videoGridWrapper) videoGridWrapper.style.display = 'none';
            if (videoListWrapper) videoListWrapper.style.display = 'block';
        };
        videoGrid.appendChild(backBtn);
        
        console.log(`[VIDEO] ‚úÖ ƒê√£ load video: ${video.name}`);
    }
    
    // D·ª´ng video
    function stopVideo(index) {
        if (videoPlayers.length > 0) {
            videoPlayers.forEach(video => {
                video.pause();
                video.currentTime = 0;
            });
            videoPlayers = [];
        }
        currentPlayingVideo = null;
        updateVideoStatus(index, false);
    }
    
    // C·∫≠p nh·∫≠t tr·∫°ng th√°i video trong list
    function updateVideoStatus(index, isPlaying) {
        const statusEl = document.getElementById(`status-${index}`);
        if (statusEl) {
            if (isPlaying) {
                statusEl.classList.add('playing');
            } else {
                statusEl.classList.remove('playing');
            }
        }
        
        // C·∫≠p nh·∫≠t button
        const listItem = document.getElementById(`video-list-item-${index}`);
        if (listItem) {
            const btn = listItem.querySelector('.video-list-item-btn');
            if (btn) {
                if (isPlaying) {
                    btn.innerHTML = '<i class="fas fa-stop"></i> D·ª´ng video';
                    btn.classList.add('active');
                } else {
                    btn.innerHTML = '<i class="fas fa-play"></i> Xem video';
                    btn.classList.remove('active');
                }
            }
        }
    }
    
    // Initialize video list on page load
    function initVideoPlayers() {
        // T·ªêI ∆ØU: Kh·ªüi t·∫°o danh s√°ch thay v√¨ load t·∫•t c·∫£ video
        initVideoList();
        
        updateCurrentTime();
        setInterval(updateCurrentTime, 1000);
    }
    
    // Update current time display (Vietnam timezone UTC+7)
    function updateCurrentTime() {
        const now = new Date();
        // Convert to Vietnam timezone (UTC+7)
        const vietnamTime = new Date(now.toLocaleString("en-US", {timeZone: "Asia/Ho_Chi_Minh"}));
        const timeString = vietnamTime.toLocaleTimeString('vi-VN', { 
            hour: '2-digit', 
            minute: '2-digit', 
            second: '2-digit',
            timeZone: 'Asia/Ho_Chi_Minh'
        });
        const dateString = vietnamTime.toLocaleDateString('vi-VN', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            timeZone: 'Asia/Ho_Chi_Minh'
        });
        document.getElementById('currentTime').textContent = `${dateString} ${timeString}`;
    }
    
    // Play all videos (legacy - gi·ªØ l·∫°i cho t∆∞∆°ng th√≠ch)
    function playAllVideos() {
        if (videoPlayers.length > 0) {
            videoPlayers.forEach(video => {
                video.play();
            });
            isAllPlaying = true;
            const playAllBtn = document.getElementById('playAllBtn');
            if (playAllBtn) playAllBtn.innerHTML = '<i class="fas fa-pause"></i> T·∫°m d·ª´ng t·∫•t c·∫£';
        }
    }
    
    // Pause all videos (legacy - gi·ªØ l·∫°i cho t∆∞∆°ng th√≠ch)
    function pauseAllVideos() {
        if (videoPlayers.length > 0) {
            videoPlayers.forEach(video => {
                video.pause();
            });
            isAllPlaying = false;
            const playAllBtn = document.getElementById('playAllBtn');
            if (playAllBtn) playAllBtn.innerHTML = '<i class="fas fa-play"></i> Ph√°t t·∫•t c·∫£';
        }
    }
    
    // Toggle play/pause all (legacy - gi·ªØ l·∫°i cho t∆∞∆°ng th√≠ch)
    function togglePlayPauseAll() {
        if (isAllPlaying) {
            pauseAllVideos();
        } else {
            playAllVideos();
        }
    }
    
    // Upload video handler
    function setupUploadHandler() {
        const uploadBtn = document.getElementById('uploadVideoBtn');
        const uploadSection = document.getElementById('uploadSection');
        const cancelBtn = document.getElementById('cancelUploadBtn');
        const uploadForm = document.getElementById('uploadForm');
        
        // Ki·ªÉm tra c√°c element c√≥ t·ªìn t·∫°i kh√¥ng
        if (!uploadBtn || !uploadSection || !cancelBtn || !uploadForm) {
            console.error('[UPLOAD] ‚ùå Missing required elements:', {
                uploadBtn: !!uploadBtn,
                uploadSection: !!uploadSection,
                cancelBtn: !!cancelBtn,
                uploadForm: !!uploadForm
            });
            return;
        }
        
        console.log('[UPLOAD] ‚úÖ Setting up upload handler');
        
        // Show upload section
        uploadBtn.addEventListener('click', function() {
            const isHidden = uploadSection.style.display === 'none' || uploadSection.style.display === '';
            uploadSection.style.display = isHidden ? 'block' : 'none';
            console.log('[UPLOAD] Upload section toggled:', uploadSection.style.display);
        });
        
        // Hide upload section
        cancelBtn.addEventListener('click', function() {
            uploadSection.style.display = 'none';
            uploadForm.reset();
            console.log('[UPLOAD] Upload cancelled');
        });
        
        // Handle form submission v·ªõi progress bar
        uploadForm.addEventListener('submit', function(e) {
            e.preventDefault();
            console.log('[UPLOAD] Form submitted');
            
            const fileInput = document.getElementById('videoInput');
            if (!fileInput) {
                console.error('[UPLOAD] ‚ùå videoInput not found');
                alert('L·ªói: Kh√¥ng t√¨m th·∫•y input file!');
                return;
            }
            
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Ch∆∞a ch·ªçn file video!');
                return;
            }
            
            console.log('[UPLOAD] üì§ Uploading file:', file.name, 'Size:', (file.size / 1024 / 1024).toFixed(2), 'MB');
            
            const formData = new FormData();
            formData.append('video', file);
            
            // T·∫°o progress bar
            let progressHTML = `
                <div class="upload-progress-container" style="margin-top: 15px; display: none;">
                    <div class="progress" style="height: 25px; border-radius: 12px; background: #e9ecef;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated bg-success" 
                             role="progressbar" 
                             style="width: 0%; line-height: 25px; font-weight: 600; color: white;"
                             id="uploadProgressBar">0%</div>
                    </div>
                    <small class="text-muted mt-2 d-block" id="uploadStatus">ƒêang t·∫£i l√™n...</small>
                </div>
            `;
            
            // Th√™m progress bar v√†o form n·∫øu ch∆∞a c√≥
            let progressContainer = uploadForm.querySelector('.upload-progress-container');
            if (!progressContainer) {
                uploadForm.insertAdjacentHTML('beforeend', progressHTML);
                progressContainer = uploadForm.querySelector('.upload-progress-container');
            }
            progressContainer.style.display = 'block';
            
            // Show loading
            const submitBtn = uploadForm.querySelector('button[type="submit"]');
            const originalBtnText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang t·∫£i l√™n...';
            
            const progressBar = document.getElementById('uploadProgressBar');
            const uploadStatus = document.getElementById('uploadStatus');
            
            // T·ªêI ∆ØU: Upload v·ªõi progress tracking
            const xhr = new XMLHttpRequest();
            
            // Track upload progress
            xhr.upload.addEventListener('progress', function(e) {
                if (e.lengthComputable) {
                    const percentComplete = (e.loaded / e.total) * 100;
                    progressBar.style.width = percentComplete + '%';
                    progressBar.textContent = Math.round(percentComplete) + '%';
                    uploadStatus.textContent = `ƒêang t·∫£i l√™n: ${Math.round(percentComplete)}% (${(e.loaded / 1024 / 1024).toFixed(2)} MB / ${(e.total / 1024 / 1024).toFixed(2)} MB)`;
                }
            });
            
            xhr.addEventListener('load', function() {
                console.log('[UPLOAD] Response received. Status:', xhr.status);
                if (xhr.status === 200) {
                    try {
                        const res = JSON.parse(xhr.responseText);
                        console.log('[UPLOAD] Response:', res);
                        if (res.status === 'ok') {
                            progressBar.style.width = '100%';
                            progressBar.textContent = '100%';
                            progressBar.classList.remove('bg-success');
                            progressBar.classList.add('bg-info');
                            uploadStatus.textContent = '‚úÖ Upload th√†nh c√¥ng! ƒêang x·ª≠ l√Ω video...';
                            
                            // ·∫®n upload section v√† reset form
                            uploadSection.style.display = 'none';
                            uploadForm.reset();
                            progressContainer.style.display = 'none';
                            
                            // Hi·ªÉn th·ªã n√∫t d·ª´ng video upload
                            document.getElementById('stopVideoUploadBtn').style.display = 'inline-block';
                            
                            // T·ªêI ∆ØU: ƒê·ª£i video processing kh·ªüi ƒë·ªông (√≠t nh·∫•t 2 gi√¢y) tr∆∞·ªõc khi th√™m player
                            // V√† th√™m video player ngay ƒë·ªÉ stream c√≥ th·ªÉ b·∫Øt ƒë·∫ßu load
                            addUploadedVideoPlayer();
                            
                            // Th√¥ng b√°o th√†nh c√¥ng
                            showNotification('‚úÖ Upload video th√†nh c√¥ng! Video ƒëang ƒë∆∞·ª£c x·ª≠ l√Ω v·ªõi detection v√† tracking...', 'success');
                        } else {
                            uploadStatus.textContent = '‚ùå Upload th·∫•t b·∫°i: ' + (res.msg || 'L·ªói kh√¥ng x√°c ƒë·ªãnh');
                            progressBar.classList.remove('bg-success');
                            progressBar.classList.add('bg-danger');
                            showNotification('‚ùå Upload video th·∫•t b·∫°i!', 'error');
                        }
                    } catch (e) {
                        uploadStatus.textContent = '‚ùå L·ªói x·ª≠ l√Ω ph·∫£n h·ªìi';
                        progressBar.classList.remove('bg-success');
                        progressBar.classList.add('bg-danger');
                        showNotification('‚ùå C√≥ l·ªói x·∫£y ra khi upload video!', 'error');
                    }
                } else {
                    uploadStatus.textContent = '‚ùå L·ªói k·∫øt n·ªëi';
                    progressBar.classList.remove('bg-success');
                    progressBar.classList.add('bg-danger');
                    showNotification('‚ùå C√≥ l·ªói x·∫£y ra khi upload video!', 'error');
                }
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnText;
            });
            
            xhr.addEventListener('error', function() {
                console.error('[UPLOAD] ‚ùå Network error');
                uploadStatus.textContent = '‚ùå L·ªói k·∫øt n·ªëi';
                progressBar.classList.remove('bg-success');
                progressBar.classList.add('bg-danger');
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnText;
                showNotification('‚ùå C√≥ l·ªói x·∫£y ra khi upload video! Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi m·∫°ng.', 'error');
            });
            
            xhr.addEventListener('abort', function() {
                console.warn('[UPLOAD] ‚ö†Ô∏è Upload aborted');
                uploadStatus.textContent = '‚ùå Upload b·ªã h·ªßy';
                progressBar.classList.remove('bg-success');
                progressBar.classList.add('bg-warning');
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnText;
            });
            
            console.log('[UPLOAD] Sending request to /upload_video');
            xhr.open('POST', '/upload_video');
            xhr.send(formData);
        });
    }
    
    // Th√™m video player cho video ƒë√£ upload (c√≥ detection/tracking)
    // S·ª¨ D·ª§NG LIVE STREAM CONTAINER ƒê∆†N GI·∫¢N - T·ªêI ∆ØU ƒê·ªÇ KH√îNG B·ªä GI·∫¨T LAG
    function addUploadedVideoPlayer() {
        console.log('[VIDEO UPLOAD] üé¨ Starting live stream...');

        // ·∫®n video list
        const videoListWrapper = document.getElementById('videoListWrapper');
        if (videoListWrapper) {
            videoListWrapper.style.display = 'none';
        }

        // Hi·ªÉn th·ªã live stream container
        const liveStreamContainer = document.getElementById('liveStreamContainer');
        const liveStreamImg = document.getElementById('liveStreamImg');

        if (liveStreamContainer && liveStreamImg) {
            liveStreamContainer.style.display = 'block';

            // T·ªêI ∆ØU: Th√™m CSS ƒë·ªÉ image render m∆∞·ª£t h∆°n
            liveStreamImg.style.imageRendering = 'auto';
            liveStreamImg.style.willChange = 'contents';
            
            // ƒê·ª£i 1.5 gi√¢y ƒë·ªÉ video processing kh·ªüi ƒë·ªông
            setTimeout(() => {
                // DUAL-STREAM: S·ª≠ d·ª•ng smooth stream (clean, m∆∞·ª£t) cho hi·ªÉn th·ªã ch√≠nh
                const streamUrl = '/video_feed_smooth?t=' + Date.now();
                liveStreamImg.src = streamUrl;
                console.log('[VIDEO UPLOAD] ‚úÖ Live stream started: /video_feed_smooth (Smooth Stream)');
                
                // Kh·ªüi t·∫°o l·∫°i canvas overlay khi video stream b·∫Øt ƒë·∫ßu
                setTimeout(() => {
                    initCanvasOverlay();
                }, 500);
            }, 1500);

            // T·ªêI ∆ØU: Error handling v·ªõi retry logic th√¥ng minh h∆°n
            let retryCount = 0;
            const maxRetries = 5;
            
            liveStreamImg.onerror = function() {
                retryCount++;
                if (retryCount <= maxRetries) {
                    const retryDelay = Math.min(2000 * retryCount, 5000); // TƒÉng delay m·ªói l·∫ßn retry
                    console.log(`[VIDEO STREAM] Error, retrying in ${retryDelay/1000}s... (${retryCount}/${maxRetries})`);
                    setTimeout(() => {
                        liveStreamImg.src = '/video_feed_smooth?t=' + Date.now();
                    }, retryDelay);
                } else {
                    console.error('[VIDEO STREAM] ‚ùå Max retries reached. Stream may not be available.');
                    liveStreamImg.alt = 'Kh√¥ng th·ªÉ t·∫£i video stream. Vui l√≤ng th·ª≠ l·∫°i.';
                }
            };

            liveStreamImg.onload = function() {
                // Reset retry count khi load th√†nh c√¥ng
                retryCount = 0;
                console.log('[VIDEO STREAM] ‚úÖ Stream loaded successfully');
            };
        } else {
            console.error('[VIDEO UPLOAD] ‚ùå Live stream container not found!');
        }
    }
    
    // Stop video upload handler
    function setupStopVideoUploadHandler() {
        const stopBtn = document.getElementById('stopVideoUploadBtn');
        
        stopBtn.addEventListener('click', function() {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën d·ª´ng video upload ƒëang ch·∫°y?')) {
                return;
            }
            
            // Disable button v√† hi·ªÉn th·ªã loading
            stopBtn.disabled = true;
            const originalBtnText = stopBtn.innerHTML;
            stopBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang d·ª´ng...';
            
            $.ajax({
                url: '/stop_video_upload',
                type: 'GET',
                success: function(res) {
                    if (res.status === 'ok') {
                        showNotification('‚úÖ ƒê√£ d·ª´ng video upload th√†nh c√¥ng!', 'success');
                        
                        // ·∫®n n√∫t d·ª´ng
                        stopBtn.style.display = 'none';
                        
                        // ·∫®n live stream container
                        const liveStreamContainer = document.getElementById('liveStreamContainer');
                        const liveStreamImg = document.getElementById('liveStreamImg');
                        if (liveStreamContainer) {
                            liveStreamContainer.style.display = 'none';
                        }
                        if (liveStreamImg) {
                            liveStreamImg.src = ''; // D·ª´ng stream
                        }
                        
                        // ƒê√≥ng SSE connection
                        if (eventSource) {
                            eventSource.close();
                            eventSource = null;
                            console.log('[SSE] Connection closed');
                        }
                        
                        // Clear canvas
                        const canvas = document.getElementById('bboxCanvas');
                        if (canvas) {
                            const ctx = canvas.getContext('2d');
                            ctx.clearRect(0, 0, canvas.width, canvas.height);
                        }

                        // X√≥a video player ƒë√£ upload (n·∫øu c√≥)
                        const uploadedVideoItem = document.getElementById('uploaded-video-item');
                        if (uploadedVideoItem) {
                            uploadedVideoItem.remove();
                        }

                        // T·ªêI ∆ØU: Hi·ªÉn th·ªã l·∫°i video list v√† ·∫©n video grid
                        const videoGridWrapper = document.getElementById('videoGridWrapper');
                        const videoListWrapper = document.getElementById('videoListWrapper');
                        if (videoGridWrapper) {
                            videoGridWrapper.style.display = 'none';
                        }
                        if (videoListWrapper) {
                            videoListWrapper.style.display = 'block';
                        }
                        
                        // T·ªêI ∆ØU: Hi·ªÉn th·ªã l·∫°i v√† resume c√°c video demo
                        const demoVideos = document.querySelectorAll('.video-item:not(.uploaded-video)');
                        demoVideos.forEach(video => {
                            video.style.display = 'block';
                            // Resume video element n·∫øu c√≥
                            const videoElement = video.querySelector('video');
                            if (videoElement) {
                                videoElement.play().catch(e => {
                                    console.log('[VIDEO] Video auto-play prevented:', e);
                                });
                            }
                        });
                        // C·∫≠p nh·∫≠t tr·∫°ng th√°i play/pause
                        isAllPlaying = true;
                        const playAllBtn = document.getElementById('playAllBtn');
                        if (playAllBtn) {
                            playAllBtn.innerHTML = '<i class="fas fa-pause"></i> T·∫°m d·ª´ng t·∫•t c·∫£';
                        }
                        console.log('[VIDEO UPLOAD] ‚úÖ ƒê√£ hi·ªÉn th·ªã l·∫°i video list v√† ·∫©n video upload');
                        
                        // Reload video players
                        initVideoPlayers();
                    } else {
                        showNotification('‚ùå C√≥ l·ªói x·∫£y ra khi d·ª´ng video upload!', 'error');
                    }
                    stopBtn.disabled = false;
                    stopBtn.innerHTML = originalBtnText;
                },
                error: function(xhr, status, error) {
                    console.error('Stop video upload error:', status, error);
                    showNotification('‚ùå C√≥ l·ªói x·∫£y ra khi d·ª´ng video upload!', 'error');
                    stopBtn.disabled = false;
                    stopBtn.innerHTML = originalBtnText;
                }
            });
        });
    }
    
    // Notification system
    function showNotification(message, type = 'info') {
        const alertBox = document.getElementById('alert-box');
        alertBox.textContent = message;
        alertBox.className = 'd-block';
        
        // Set color based on type
        if (type === 'success') {
            alertBox.style.background = '#d4edda';
            alertBox.style.borderColor = '#28a745';
            alertBox.style.color = '#155724';
        } else if (type === 'error') {
            alertBox.style.background = '#f8d7da';
            alertBox.style.borderColor = '#dc3545';
            alertBox.style.color = '#721c24';
        } else {
            alertBox.style.background = '#d1ecf1';
            alertBox.style.borderColor = '#17a2b8';
            alertBox.style.color = '#0c5460';
        }
        
        // Auto hide after 5 seconds
        setTimeout(() => {
            alertBox.className = 'd-none';
        }, 5000);
    }
    
    // Real-time history updates v·ªõi SSE
    function setupRealTimeHistory() {
        const historyTable = document.getElementById('history-table');
        
        // Load initial data
        function loadHistory() {
            $.ajax({
                url: '/violations',
                type: 'GET',
                success: function(data) {
                    if (Array.isArray(data) && data.length > 0) {
                        renderHistoryTable(data);
                    }
                },
                error: function() {
                    console.error('Error loading history');
                }
            });
        }
        
        // Render history table
        function renderHistoryTable(violations) {
            if (!violations || violations.length === 0) {
                historyTable.innerHTML = `
                    <tr>
                        <td colspan="10" class="text-center text-muted">
                            <i class="fas fa-inbox"></i> Ch∆∞a c√≥ d·ªØ li·ªáu vi ph·∫°m
                        </td>
                    </tr>
                `;
                document.getElementById('history-count').textContent = '0 vi ph·∫°m';
                return;
            }
            
            historyTable.innerHTML = '';
            violations.forEach(function(v) {
                const row = document.createElement('tr');
                const speedColor = v.speed > v.speed_limit ? '#dc3545' : '#28a745';
                const vehicleClassBadge = getVehicleClassBadge(v.vehicle_class);
                // Format time v·ªõi Vietnam timezone (UTC+7)
                let timeStr = 'N/A';
                if (v.time) {
                    try {
                        const date = new Date(v.time);
                        // Convert to Vietnam timezone (UTC+7)
                        const vietnamTime = new Date(date.toLocaleString("en-US", {timeZone: "Asia/Ho_Chi_Minh"}));
                        timeStr = vietnamTime.toLocaleString('vi-VN', { 
                            timeZone: 'Asia/Ho_Chi_Minh',
                            day: '2-digit',
                            month: '2-digit',
                            year: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit',
                            second: '2-digit'
                        });
                    } catch (e) {
                        timeStr = v.time;
                    }
                }
                
                // Format gi·ªëng view_violations.html (b·ªè c·ªôt Tr·∫°ng th√°i v√† video)
                row.innerHTML = `
                    <td><strong>${v.plate || 'N/A'}</strong></td>
                    <td>${vehicleClassBadge}</td>
                    <td>${v.owner_name || 'Kh√¥ng r√µ'}</td>
                    <td>${v.address || 'Kh√¥ng r√µ'}</td>
                    <td>${v.phone || 'Kh√¥ng r√µ'}</td>
                    <td><strong style="color: ${speedColor};">${parseFloat(v.speed || 0).toFixed(1)} km/h</strong></td>
                    <td>${v.speed_limit || 40} km/h</td>
                    <td><strong style="color: #dc3545;">${(parseFloat(v.speed || 0) - parseFloat(v.speed_limit || 40)).toFixed(1)} km/h</strong></td>
                    <td>${timeStr}</td>
                    <td>
                        ${v.plate_image ? `
                            <img src="/violations/${v.plate_image}" 
                                 class="plate-img" 
                                 style="max-width: 100px; border-radius: 4px; cursor: pointer;" 
                                 onclick="window.open(this.src, '_blank')"
                                 alt="Bi·ªÉn s·ªë ${v.plate || ''}"
                                 onerror="this.onerror=null; this.outerHTML='<span class=\\'text-muted\\'>N/A</span>';">
                        ` : '<span class="text-muted">N/A</span>'}
                    </td>
                    <td>
                        ${v.image ? `
                            <img src="/violations/${v.image}" 
                                 class="history-img" 
                                 style="max-width: 150px; border-radius: 4px; cursor: pointer;"
                                 onclick="window.open(this.src, '_blank')"
                                 alt="·∫¢nh vi ph·∫°m"
                                 onerror="this.onerror=null; this.outerHTML='<span class=\\'text-muted\\'>N/A</span>';">
                        ` : '<span class="text-muted">N/A</span>'}
                    </td>
                `;
                historyTable.appendChild(row);
            });
            
            // Update count badge
            document.getElementById('history-count').textContent = `${violations.length} vi ph·∫°m`;
        }
        
        // Helper function for vehicle class badge - gi·ªëng view_violations.html
        function getVehicleClassBadge(vehicleClass) {
            if (vehicleClass === 'car') {
                return '<span class="badge badge-primary">√î T√î</span>';
            } else if (vehicleClass === 'motorcycle') {
                return '<span class="badge badge-info">XE G·∫ÆN M√ÅY</span>';
            } else if (vehicleClass === 'bus') {
                return '<span class="badge badge-warning">XE BUS</span>';
            } else if (vehicleClass === 'truck') {
                return '<span class="badge badge-secondary">XE T·∫¢I</span>';
            } else {
                return '<span class="badge badge-light">N/A</span>';
            }
        }
        
        // Load initial data
        loadHistory();
        
        // T·ªêI ∆ØU: TƒÉng interval t·ª´ 3 gi√¢y l√™n 5 gi√¢y ƒë·ªÉ gi·∫£m t·∫£i server
        setInterval(loadHistory, 5000);
    }
    
    // Event listeners
    document.getElementById('playAllBtn').addEventListener('click', togglePlayPauseAll);
    document.getElementById('pauseAllBtn').addEventListener('click', pauseAllVideos);
    
    // Function to edit location for camera (c·∫≠p nh·∫≠t cho c·∫£ video list v√† video player)
    function editLocation(cameraNumber, locationElement) {
        const currentLocation = locationElement.getAttribute('data-location') || '';
        
        // Create input field
        const input = document.createElement('input');
        input.type = 'text';
        input.className = 'video-location-input';
        input.value = currentLocation;
        input.placeholder = 'Nh·∫≠p t√™n ƒë∆∞·ªùng (VD: ƒê∆∞·ªùng Nguy·ªÖn VƒÉn A, Qu·∫≠n 1)';
        
        // Replace location div with input
        const oldText = locationElement.textContent;
        locationElement.innerHTML = '';
        locationElement.appendChild(input);
        input.focus();
        input.select();
        
        // Save on Enter or blur
        const saveLocation = function() {
            const newLocation = input.value.trim();
            if (newLocation) {
                locationElement.textContent = `üìç ${newLocation}`;
                locationElement.setAttribute('data-location', newLocation);
                // Save to localStorage
                localStorage.setItem(`camera_${cameraNumber}_location`, newLocation);
                console.log(`[LOCATION] Camera ${cameraNumber} location saved: ${newLocation}`);
                
                // T·ªêI ∆ØU: C·∫≠p nh·∫≠t location trong video list n·∫øu c√≥
                const listLocationText = document.getElementById(`location-text-${cameraNumber - 1}`);
                if (listLocationText) {
                    listLocationText.textContent = newLocation;
                }
            } else {
                locationElement.textContent = 'üìç Nh·∫•n ƒë·ªÉ nh·∫≠p t√™n ƒë∆∞·ªùng';
                locationElement.setAttribute('data-location', '');
                // Remove from localStorage
                localStorage.removeItem(`camera_${cameraNumber}_location`);
                
                // T·ªêI ∆ØU: C·∫≠p nh·∫≠t location trong video list n·∫øu c√≥
                const listLocationText = document.getElementById(`location-text-${cameraNumber - 1}`);
                if (listLocationText) {
                    listLocationText.textContent = 'Ch∆∞a ƒë·∫∑t t√™n ƒë∆∞·ªùng';
                }
            }
        };
        
        input.addEventListener('blur', saveLocation);
        input.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                saveLocation();
            }
            if (e.key === 'Escape') {
                // Cancel editing
                const savedLocation = localStorage.getItem(`camera_${cameraNumber}_location`) || '';
                if (savedLocation) {
                    locationElement.textContent = `üìç ${savedLocation}`;
                    locationElement.setAttribute('data-location', savedLocation);
                } else {
                    locationElement.textContent = 'üìç Nh·∫•n ƒë·ªÉ nh·∫≠p t√™n ƒë∆∞·ªùng';
                    locationElement.setAttribute('data-location', '');
                }
            }
        });
    }
    
    // ===== CANVAS OVERLAY SYSTEM =====
    const CANVAS_CONFIG = {
        SSE_URL: '/detection_stream',
        BBOX_COLORS: {
            normal: '#00FF00',
            violation: '#FF0000',
            tracking: '#FFFF00'
        },
        BBOX_WIDTH: 3,
        TEXT_FONT: '16px Arial',
        TEXT_COLOR: '#FFFFFF',
        TEXT_BG_ALPHA: 0.7,
        SHOW_BBOX: true,
        SHOW_SPEED: true,
        SHOW_PLATE: true
    };

    let eventSource = null;
    let latestDetections = [];
    let videoResolution = [1920, 1080];
    let speedLimit = 40;

    function initCanvasOverlay() {
        const videoImg = document.getElementById('liveStreamImg');
        const canvas = document.getElementById('bboxCanvas');
        
        if (!videoImg || !canvas) {
            console.log('[CANVAS] Video or canvas not found, skipping overlay init');
            return;
        }

        const ctx = canvas.getContext('2d');

        function syncCanvasSize() {
            canvas.width = videoImg.clientWidth;
            canvas.height = videoImg.clientHeight;
        }

        videoImg.addEventListener('load', syncCanvasSize);
        window.addEventListener('resize', syncCanvasSize);
        syncCanvasSize();

        function connectSSE() {
            if (eventSource) {
                eventSource.close();
            }

            eventSource = new EventSource(CANVAS_CONFIG.SSE_URL);

            eventSource.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    latestDetections = data.detections || [];
                    videoResolution = data.video_resolution || [1920, 1080];
                    speedLimit = data.speed_limit || 40;
                    drawDetections(ctx, canvas);
                } catch (e) {
                    console.error('[SSE] Parse error:', e);
                }
            };

            eventSource.onerror = (error) => {
                console.error('[SSE] Connection error:', error);
                eventSource.close();
                setTimeout(connectSSE, 3000);
            };

            console.log('[SSE] Connected to detection stream');
        }

        function drawDetections(ctx, canvas) {
            if (!CANVAS_CONFIG.SHOW_BBOX) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                return;
            }

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            const scaleX = canvas.width / videoResolution[0];
            const scaleY = canvas.height / videoResolution[1];

            latestDetections.forEach(det => {
                drawBoundingBox(ctx, det, scaleX, scaleY);
            });
        }

        function drawBoundingBox(ctx, detection, scaleX, scaleY) {
            const [x1, y1, x2, y2] = detection.bbox;
            const x = x1 * scaleX;
            const y = y1 * scaleY;
            const w = (x2 - x1) * scaleX;
            const h = (y2 - y1) * scaleY;

            const color = detection.violation 
                ? CANVAS_CONFIG.BBOX_COLORS.violation 
                : CANVAS_CONFIG.BBOX_COLORS.normal;

            ctx.strokeStyle = color;
            ctx.lineWidth = CANVAS_CONFIG.BBOX_WIDTH;
            ctx.strokeRect(x, y, w, h);

            if (CANVAS_CONFIG.SHOW_SPEED || CANVAS_CONFIG.SHOW_PLATE) {
                drawTextInfo(ctx, detection, x, y, color);
            }
        }

        function drawTextInfo(ctx, detection, x, y, color) {
            let textLines = [];
            textLines.push(`ID: ${detection.track_id}`);

            if (CANVAS_CONFIG.SHOW_SPEED && detection.speed !== null) {
                textLines.push(`${detection.speed.toFixed(1)} km/h`);
            }

            if (CANVAS_CONFIG.SHOW_PLATE && detection.plate) {
                textLines.push(`üöó ${detection.plate}`);
            }

            ctx.font = CANVAS_CONFIG.TEXT_FONT;
            const lineHeight = 20;
            const padding = 5;
            const maxWidth = Math.max(...textLines.map(t => ctx.measureText(t).width));

            ctx.fillStyle = `rgba(0, 0, 0, ${CANVAS_CONFIG.TEXT_BG_ALPHA})`;
            ctx.fillRect(
                x,
                y - (textLines.length * lineHeight + padding),
                maxWidth + padding * 2,
                textLines.length * lineHeight + padding
            );

            ctx.fillStyle = color;
            textLines.forEach((line, i) => {
                ctx.fillText(
                    line,
                    x + padding,
                    y - (textLines.length - i - 1) * lineHeight - padding
                );
            });
        }

        const toggleBboxBtn = document.getElementById('toggleBbox');
        const toggleSpeedBtn = document.getElementById('toggleSpeed');
        const bboxStatus = document.getElementById('bboxStatus');
        const speedStatus = document.getElementById('speedStatus');

        if (toggleBboxBtn) {
            toggleBboxBtn.addEventListener('click', () => {
                CANVAS_CONFIG.SHOW_BBOX = !CANVAS_CONFIG.SHOW_BBOX;
                bboxStatus.textContent = `Bbox: ${CANVAS_CONFIG.SHOW_BBOX ? 'ON' : 'OFF'}`;
                drawDetections(ctx, canvas);
            });
        }

        if (toggleSpeedBtn) {
            toggleSpeedBtn.addEventListener('click', () => {
                CANVAS_CONFIG.SHOW_SPEED = !CANVAS_CONFIG.SHOW_SPEED;
                speedStatus.textContent = `Speed: ${CANVAS_CONFIG.SHOW_SPEED ? 'ON' : 'OFF'}`;
                drawDetections(ctx, canvas);
            });
        }

        connectSSE();
        console.log('[Canvas Overlay] Initialized');
    }

    // Initialize on page load - T·ªêI ∆ØU: Defer heavy operations
    $(document).ready(function() {
        console.log('[INIT] Page loaded, initializing...');
        
        // T·ªêI ∆ØU: Load video players ngay
        initVideoPlayers();
        
        // Initialize canvas overlay
        initCanvasOverlay();
        
        // Ki·ªÉm tra v√† setup upload handler ngay
        function setupUploadHandlers() {
            try {
                setupUploadHandler();
                setupStopVideoUploadHandler();
                console.log('[INIT] ‚úÖ Upload handlers setup complete');
            } catch (e) {
                console.error('[INIT] ‚ùå Error setting up upload handlers:', e);
                // Retry sau 1 gi√¢y
                setTimeout(setupUploadHandlers, 1000);
            }
        }
        
        // T·ªêI ∆ØU: Defer c√°c operations n·∫∑ng
        setTimeout(setupUploadHandlers, 100);
        
        // T·ªêI ∆ØU: Defer real-time history ƒë·ªÉ kh√¥ng block initial load
        setTimeout(() => {
            setupRealTimeHistory();
        }, 500);
        
        // T·ªêI ∆ØU: Auto play videos sau khi page ƒë√£ load xong
        setTimeout(() => {
            playAllVideos();
        }, 1000);
    });
</script>
{% endblock %}
